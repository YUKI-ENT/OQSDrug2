# OQSDrug2 ： オンライン資格確認 xml薬剤情報取得表示ソフト <<薬剤情報、AI機能(ollama)強化版>>

## 概要

[OQSDrug version1](https://github.com/YUKI-ENT/OQSDrug)の後継バージョンです。
主な変更点としては、
- バックエンドデータベースをAccess mdb形式からPostgreSQLに変更
- 薬剤添付文書情報を持たせており、薬剤相互作用情報（併用禁忌や注意）のリスト形式表示が可能
- **AI機能**：ローカルLLMである`ollama`が使える環境では、xml薬歴取得後、**自動で投薬内容から疾患状況を推論して表示**可能
- 現在は添付文書詳細は`RSBase`に依存していますが、将来的に薬剤添付文書も本ツールから表示可能にする予定
- 添付文書情報もPostgreSQLに構造化した状態（JSON形式）で保存してありますので、今後LLMの学習等に利用加工が可能
  
となっております。

逆にVersion1からは、**PDF形式でのファイリング機能は削除しました**。引き続きPDF形式で薬歴を見たい方は、RSBaseやOQSDrug version1系統を利用するようにお願いします。

<<相互作用表示画面>>
![DI2](https://github.com/user-attachments/assets/c47418ce-bf79-4eee-94c1-7367034a4381)

<<AI推論表示画面>>
![DI3](https://github.com/user-attachments/assets/a66d916c-3d1b-4d73-943d-30db991f9952)

 

---

## 動作条件
- **PostgreSQL**
  - ある程度は従来のAccess mdb形式(OQSDrug_data.mdb)でも動作しますが、**薬剤併用情報やAI機能はPostgreSQL使用時しか動作しない**ようにしてあります。
  - PostgreSQLのバージョンは**15以上**が推奨です。RSBaseのPostgreSQLサーバーにデータを置くこともできるかもしれませんが、バージョンが古いPostgreSQLですとJSONB形式の保存や検索ができない可能性があるので、できれば別サーバーで新しいバージョンのものを入れてください。
  [PostgreSQLダウンロードサイト](https://www.postgresql.jp/download) からサーバーOSにあったものをダウンロードしてインストールしてください。
  - 設定はデフォルトで動くと思いますが、Windowsではインストール時に管理者(postgres)パスワードの設定、ディスク領域の余裕あるドライブにデータベース保存場所の選択はしておいてください。
  - 外部からアクセス可能にする設定：`pg_hba.conf` **の追記、Windowsファイヤーウォールのポート5432の開放**は必要です。
    
- **Ollama (Local LLMランタイム)**
  - Ollamaが利用できる環境では、**病名病態等の推論機能**が利用できます
  - 病名の推論では、`gemma3:12b`、`gpt-oss:20b` あたりが安定した出力でした。これらのモデルを動かすには、16GB以上のVRAMを積んだNvidia製GPUが必要です。当方では、**CPU Intel Corei9-9900、メモリ32GB、GeForce RTX5080 16GB/ Ubuntu24.04の環境**で安定動作を確認しました。
  - Windows、Macでも動作するようですので、[ダウンロードサイト](https://ollama.com/download/windows) からインストールしてください。
  - OllamaもLAN内のPCからアクセスできるよう設定が必要です。
    
- **ダイナミクス**  
  ダイナミクスが本ソフトの必須環境です。

- **RSBase**  
  RSBaseがあればRSBaseの薬剤情報詳細を表示できます

### 実行環境
- .NET 4.8Frameworkが必要です。最近のWindows10以上ではデフォルトでインストールされていますが、起動できない場合、以下のリンクから **.NET Framework 4.8 ランタイム** をダウンロードしてください：  
[公式ダウンロードページ](https://dotnet.microsoft.com/ja-jp/download/dotnet-framework/net48)
 
- **Accessデータベースエンジン**  
  実行PCにAccessデータベースエンジンが必要です。
  - **Access 32bit版** のインストール
  - または **Access ランタイム 32bit版** のインストール
   ( [公式ダウンロードページ](https://www.microsoft.com/ja-jp/download/details.aspx?id=50040) )
    で導入されます。

---

## 設置方法

1. [Release一覧](https://github.com/YUKI-ENT/OQSDrug2/releases)から**OQSDrug2_v2.xx.xx.xx.exe(インストーラになってます) をダウンロード**
2. 実行するとインストールが始まります。
3. <<**初回または薬剤情報バージョンアップ時のみ**>>`DrugSGMLdata_xxxxxxxx.backup` をダウンロードしてインポート作業を行ってください。
---

## 運用方法：Version1と同様
運用方法は、Version1のときと同じく、推奨は１のように、OQSDrug専用のPCで実行する運用です。２の方法では、**クライアントダイナミクスが時々数秒フリーズしたようになる** ことがあります。

### 1.  【**推奨**】OQSDrug専用PCを用意する
  - ダイナミクスネットワーク内で、ダイナミクスクライアントが動作していないPCで、OQSDrugを実行
  - OQSDrugの設定で、「ダイナミクスの場所」は **ダイナミクスサーバーのdatadyna.mdb** を指定
  - 「開始」で取込開始
  - 診察室PC等ダイナクライアントを実行しているPCでは、取込は行わずOQSDrugを実行し、設定⑪の連携設定を行った上メイン画面のID連携設定ボタンをオンにしておくとカルテ遷移に連動して薬歴等がポップアップで開きます
  ![oqsdrug131](https://github.com/user-attachments/assets/5ac777e0-2100-4c0d-b218-74940e1b3793)


    
### 2. ダイナミクスクライアントの動作しているPCで、OQSDrugの取込動作とViewerを同時に使う
  - 別PCを用意できない場合、ダイナクライアントで稼働させます
  - 設定では、「ダイナミクスの場所」は **ダイナクライアントの稼働しているDyna_cnt.mdb**を指定します。**Datadynaを指定するとdatadynaが破損する可能性があります**
  - ダイナクライアントをバージョンアップしたときは、新しいクライアントを指定する必要があります。
  - 設定⑪の連携設定を行った上メイン画面のID連携設定ボタンをオンにしておくとカルテ遷移に連動して薬歴等がポップアップで開きます
    ![oqsdrug132](https://github.com/user-attachments/assets/3ab09f00-70f3-4863-af46-58a25707096a)


## 設定と動作の説明

起動後に以下の設定を行います：

- **メインウィンドウ**
   
   - ②に現在の状態が表示されます。NGとなっている項目があると動作開始ができませんので、まず①の設定を行ってください。
   - ③は取得結果が表示されます
   - ④は動作ログが表示されます
   - ⑤ `開始` を押すと取込作業を開始し、ボタン名が`停止`になります。もう一度押すと停止します。取込間隔は`設定`で設定します（デフォルト値30秒）
   - ⑥ RSBase連動`薬歴`、`健診`は、設定でRSBaseの連携(ID.datまたはtemp_rs.txtまたはthept.txt)が設定されている場合、ここをチェックすると患者遷移に連動して薬歴がある場合自動で薬歴をポップアップ表示します。（thept.txtが最も安定しているように思います）
   - `自動開始`をチェックすると、下の4つの設定値がすべてOKになると自動で取得開始し、1つでもNGになると停止します。

    ![oqsdrug81](https://github.com/user-attachments/assets/d9cc1b0a-d3ae-4d3a-ad57-e7d4e8cee2db)

      
- **設定**

  ① OQS_data.mdbの場所を指定します。ダイナサーバーに置くのをおすすめします。<br>
  ② ダイナミクスの場所は、上記`運用方法`に記載したとおり、別PCで実行するときは**ダイナサーバーのdatadyna.mdb**、クライアントで実行するときは**クライアントダイナ**を指定してください。<br>
  ③ オン資端末のreq,resフォルダを含むフォルダを指定<br>
  ④ PDFを**RSBaseの検査として**保存するときは、RSBaseかRSAutoの取込フォルダを指定。RSBaseを使用しない場合は、PDFを保存する適当なフォルダを指定してください<br>
     `RSBase reload`をチェックしてRSBaseのトップ画面のUrlを入力すると、PDF取得後Urlをリロードしてファイリングします。RSAuto等で自動ファイリングする場合は指定不要です。<br>
  ⑤ PDFを**RSBaseのサイドショー**に保存するときは、RSBaseのサーバーフォルダーを指定してください。
  ⑥  `医療機関コード`は10桁のものです<br>
  ⑦  動作間隔は既定で30秒です。<br>
  ⑧⑨  `薬剤情報``特定健診`のグループは **PDF** をRSBaseにファイリングするときに使用してください。RSBaseの検査として登録されます。ダイナミクス標準機能で自動取得し、**RSBaseのPDFから変換する設定を利用してる方は使用しないほうがいい**と思います。<br>
       xmlの薬歴、健診は標準で必ず取得します。<br>
       **RSBaseでxmlを取り込むときは、`xmlを削除しない`をチェックし、xmlリロードもOQSDrugから行うときは、`RSBase xml reload`のチェックとURLの記入をお願いします**<br>
  ⑩ 指定するとタスクトレイに最小化した状態で起動します<br>
  ⑪ `RSBase連動`は、ID.dat, temp_rs.txt、thept.txt方式に対応しますが、**thept.txtが一番安定している**ようです。RSBaseの`(52)  c:\common\thept.txt (&& c:\ID_temp.txt)にIDを出力 `をyesにしてください。<br>
     また、ダイナミクスの他社連携を利用してのID連携も可能です。[参照](https://github.com/YUKI-ENT/OQSDrug/releases/tag/v1.25.2.10) <br>
  ⑫ `薬歴を最前面で表示`をチェックすると、薬歴ウインドウが最前面で表示されるようになります<br>
  ⑫ ビュワー表示時の初期期間を設定します<br>
  
    ![oqsdrug82](https://github.com/user-attachments/assets/b60123b4-5bea-4df2-b0de-630cb1932e8f)

 
- **タスクトレイアイコン**

    ![oqsdrug45](https://github.com/user-attachments/assets/02a39560-6d01-4a0a-a55e-3370e171398c)


   - タスクトレイから開始・停止、ビュワーの表示などの操作が行えます
   - 薬歴取得動作中はタスクトレイアイコンがアニメーションで回転します
 
   
- **薬歴ビュワーウインドウ**
   
   - ウインドウサイズと位置を記憶しますので、初回に適宜見やすい場所に移動して閉じてみてください。次回以降起動時はその位置サイズで表示されます。ウインドウが行方不明になったときは、`設定`で`位置サイズをリセット`のボタンを押すと、メインウィンドウ近くに表示されます。
   - `月ごと集計`がオンのときは、各医療機関ごとの処方を月ごとに合計して表示します。オフのときは処方日毎の表示になります。見やすい方で適宜切り替えてください。
   - `自院除外`をオンにすると、自院での処方を表示せず、他院からの処方のみ表示します。
   - メインウィンドウで、`薬歴自動起動`のオプションを設定すると、カルテ遷移しそのカルテ番号で過去の薬歴があれば薬歴ビュワーウインドウをポップアップで表示し、薬歴がなければウィンドウを閉じます。

      ![oqsdrug53](https://github.com/user-attachments/assets/0354db98-72d6-4440-a6e2-7885f8b48a63)

        
   - セルを選択して右クリックすると、コンテキストメニューが利用できます。
      ![oqsdrug11](https://github.com/user-attachments/assets/37f0404a-90e9-477d-9fd4-1d90e36b9489)
     
   - 複数セルの全角/半角コピーが可能です
   - **実行しているPCにRSBaseがインストールされている場合**、`薬情検索`メニューが表示されます。これを選択すると、現在選択されているセルの薬情をRSBaseで表示するとともに、あいまい検索でRSBase薬情に登録されている薬剤名一覧が表示されます。
   - `RSBase薬情検索` フォームでは、リストをダブルクリックで該当薬情のRSBaseページを開きます。下のテキストボックスは、手入力で修正するときに使ってください。
   ![oqsdrug12](https://github.com/user-attachments/assets/a1a826fb-2ef5-4415-8eec-2a59c384fc1d)


- **特定健診ビュワーウインドウ**     

  - セルの選択、右クリックでデータのコピーに対応しています
    
     ![oqsdrug44](https://github.com/user-attachments/assets/cd051cb0-dbde-4935-8e11-9082643b7e2f)

---

## 注意事項
- 薬歴は`OQSDrug_Data.mdb`に蓄積されていきます。バージョンアップ時に上書きしてしまうと過去に取得した薬歴が消えてしまいますので、初回以外は上書きしないようにおねがいします。
  また`OQSDrug_Data.mdb`のバックアップも適宜取っておいてください。
- **稀にダイナミクスの動作が不安定になることがあります。datadyna.mdbのバックアップはしっかり取っていただき、もしダイナミクスの動作に支障をきたす場合は直ちに使用を中止してください。**
- ダイナミクスの最適化を行うときや、他のクライアントから書き込みを行うときは、本ソフトの動作を止めるようにお願いします。
- 必ず32bit版のAccessまたはAccessランタイムを使用してください。
- 現状xmlは薬剤履歴のみ対応しています。健診情報や診療手術情報はPDFの方が見やすそうなので、当面対応予定はありません。
- 要望、改善案などは何なりとご連絡あるいはDisscussionに投稿等よろしくお願いいたします。できる範囲でなるべく対応したいと思います。

---

## 今後の予定
- バグ取り
- バックエンドデータベースにmdbを使っていますが、データが増えると安定動作が難しいですので、RSBaseで利用しているPostgreSQLをバックエンドにすることを検討してます。
  
